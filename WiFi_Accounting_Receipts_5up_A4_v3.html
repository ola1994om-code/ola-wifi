<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,viewport-fit=cover"/>
  <meta name="theme-color" content="#2563eb"/>
  <title>WiFi Accounting â€” Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø´Ø±ÙƒØ© Ø¥Ù†ØªØ±Ù†Øª (Ø¥ÙŠØµØ§Ù„Ø§Øª)</title>

  <style>
    :root{
      --bg1:#f6f9ff;
      --bg2:#eef5ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#2563eb;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --r:18px;
      --shadow: 0 12px 30px rgba(15,23,42,.08);

      --headerH: 150px; /* ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ù€ JS */
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html, body{
      height:100%;
      overflow:hidden; /* âœ… Ø§Ù„ØµÙØ­Ø© Ù†ÙØ³Ù‡Ø§ Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠØ± */
    }
    body{
      margin:0;
      font-family:Tahoma,Arial;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    .container{max-width:1200px;margin:auto;padding:14px}

    /* Header fixed */
    header{
      position:fixed;
      top:0; left:0; right:0;
      z-index:50;
      background:rgba(246,249,255,.90);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding-top: var(--safeTop);
    }

    .brand{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .brand h1{margin:0;font-size:18px}
    .pill{font-size:12px;color:var(--muted);line-height:1.4}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:10px
    }
    .tab{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      touch-action: manipulation;
    }
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}

    /* Main fixed area */
    #appMain{
      position:fixed;
      top: calc(var(--headerH) + var(--safeTop));
      left:0; right:0;
      bottom: var(--safeBot);
      overflow:hidden; /* âœ… */
    }
    #appMain .container{
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:0;
      padding-bottom: calc(14px + var(--safeBot));
    }

    /* Stats */
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .stat{
      flex:1;min-width:220px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
    }
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:20px;margin-top:6px}

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      flex:1;
      min-height:0;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);

      display:flex;
      flex-direction:column;
      min-height:0; /* Ù…Ù‡Ù… Ù„Ù„Ù€ overflow Ø¯Ø§Ø®Ù„ body */
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      flex:0 0 auto;
    }
    .card .bd{
      padding:12px 14px;
      overflow:auto;      /* âœ… Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙ‚Ø· */
      -webkit-overflow-scrolling: touch; /* âœ… Fix iOS freeze */
      min-height:0;
      flex:1 1 auto;
    }

    h2{margin:0;font-size:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      padding:10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:80px;resize:vertical}

    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;
      touch-action: manipulation;
      white-space:nowrap;
    }
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    table{width:100%;border-collapse:collapse}
    th,td{
      padding:10px;border-bottom:1px solid var(--line);
      font-size:13px;text-align:right;vertical-align:top;
    }
    th{color:var(--muted);font-weight:700;font-size:12px}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      border-radius:999px;padding:6px 10px;
      font-size:12px;border:1px solid var(--line);background:#fff
    }
    .b-ok{border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.08);color:var(--ok)}
    .b-warn{border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.10);color:var(--warn)}
    .b-danger{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.10);color:var(--danger)}
    .muted{color:var(--muted)}
    .tiny{font-size:11px;color:var(--muted)}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .split > *{flex:1;min-width:160px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .search{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search input{max-width:360px}

    /* Countdown cards (NO circle overlay âœ…) */
    .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .ccard{
      border:1px solid rgba(15,23,42,.08);
      border-radius:22px;
      box-shadow:0 18px 44px rgba(2,6,23,.10);
      padding:14px 14px;
      cursor:pointer;
      color:#0f172a;
      position:relative;
      overflow:hidden;
      touch-action: manipulation;
    }

    .ccard .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .ccard .name{font-size:15px;font-weight:900}
    .ccard .meta{margin-top:4px}

    .countdown{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .cd{
      min-width:74px;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.78);
      text-align:center;
      backdrop-filter: blur(8px);
    }
    .cd .n{font-size:18px;font-weight:900;color:#0f172a}
    .cd .t{font-size:11px;color:#334155;margin-top:3px}

    .pill2{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;font-size:12px
    }

    
    /* Receipt layout (screen + print) */
    .receiptScreen{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px;
      overflow:hidden;
    }
    .receiptRow{display:flex;gap:12px;height:100%}
    .receiptCol{display:flex;flex-direction:column;gap:10px;height:100%}
    .copy{flex:1;min-width:0;display:flex;flex-direction:column}
    .receiptRow .copy + .copy{border-inline-start:1px dashed #cbd5e1;padding-inline-start:12px;margin-inline-start:0}
    .rhead{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .rbrand{display:flex;gap:10px;align-items:center;min-width:0}
    .rlogo{width:44px;height:44px;object-fit:contain;border:1px solid var(--line);border-radius:14px;padding:4px;background:#fff;flex:0 0 auto}
    .rlogo.alt{display:flex;align-items:center;justify-content:center;font-size:20px}
    .rbrandTxt{min-width:0}
    .rbrandName{font-weight:900;font-size:14px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rbrandMeta{font-size:11px;color:var(--muted);line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .copyTag{font-size:11px;font-weight:900;border:1px solid var(--line);border-radius:999px;padding:4px 10px;background:#f8fafc;white-space:nowrap}
    .rline{height:1px;background:#e5e7eb;margin:8px 0}
    .rrow{display:flex;justify-content:space-between;gap:10px;font-size:12px}
    .rrow span{color:var(--muted)}
    .rmuted{font-size:11px;color:var(--muted);margin-top:2px}
    .rsig{margin-top:auto;border-top:1px dashed #cbd5e1;padding-top:8px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between}

    @media print{
      .receiptScreen{ box-shadow:none !important; }
      .receiptRow{ gap:0 !important; }
      .receiptRow .copy + .copy{ padding-inline-start:2mm !important; }
      .rlogo{ width:9mm !important; height:9mm !important; border-radius:3mm !important; padding:1mm !important; }
      .rbrandName{ font-size:10pt !important; }
      .rbrandMeta{ font-size:7.5pt !important; }
      .copyTag{ font-size:7.5pt !important; padding:1mm 2mm !important; }
      .rline{ margin:1.5mm 0 !important; }
      .rrow{ font-size:8.5pt !important; }
      .rmuted{ font-size:7.5pt !important; }
      .rsig{ font-size:7.5pt !important; padding-top:1.5mm !important; }
    }
/* Overlays */
    .overlay{
      position:fixed;inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:12px;
      z-index:80;
    }
    .overlay.show{display:flex}
    .box{
      width:min(980px,100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
      max-height:calc(100vh - 24px);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .box .hd{
      padding:12px 14px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
    }
    .box .bd{
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch; /* âœ… Fix iOS freeze */
      min-height:0
    }

    /* Receipt fullscreen page (NO SCROLL, auto fit) */
    .invpage{
      position:fixed;inset:0;background:#f8fafc;
      display:none;flex-direction:column;z-index:90;
    }
    .invpage.show{display:flex}

    .invbar{
      background:rgba(246,249,255,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding-top: var(--safeTop);
    }
    .invbar .title{font-weight:900}

    .invcontent{
      padding:10px;
      height: calc(100vh - 74px - var(--safeTop));
      overflow:hidden; /* âœ… Ù…Ù…Ù†ÙˆØ¹ ØªÙ…Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„ */
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding-bottom: var(--safeBot);
    }

    #invoiceStage{
      display:inline-block;
      transform-origin: top center;
      will-change: transform;
    }
    #invoiceView{display:inline-block}

    /* Bulk print area (hidden on screen) */
    #printArea{display:none}

    /* Mobile behavior */
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      #leftPanel{display:none} /* âœ… Ù†Ø®ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠØ³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ */
      .cards{grid-template-columns:1fr}
      .search input{max-width:100%}
      .row.stats{display:none} /* âœ… Ù„ØªØ¨Ù‚Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø«Ø§Ø¨ØªØ© */
    }
    .btn.addMobile{display:none}
    @media(max-width:980px){ .btn.addMobile{display:inline-flex} }

    /* Print rules */
    @media print{
      header, .no-print, .invbar{display:none !important}
      body{background:#fff}
      .invpage{position:static;display:block;background:#fff}
      .invcontent{height:auto;overflow:visible;padding:0}
      #invoiceStage{transform:none !important}

      /* bulk printing */
      body.bulk-printing .invpage{display:none !important}
      body.bulk-printing #printArea{display:block !important}
    }
  </style>

  <style id="dynamicPrintStyle"></style>
</head>

<body>

<noscript>
  <div style="position:fixed;inset:0;z-index:9999;background:#fff;padding:18px;font-family:Tahoma,Arial">
    <div style="max-width:720px;margin:0 auto;border:1px solid #e5e7eb;border-radius:16px;padding:16px">
      <div style="font-size:18px;font-weight:900;margin-bottom:8px">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªØ§Ø¬ JavaScript</div>
      <div style="color:#475569;line-height:1.6">
        ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ ÙØªØ­ØªÙ‡ Ø¯Ø§Ø®Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ù…Ø«Ù„ Google Drive/Telegram/Ø¨Ø¹Ø¶ Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª)ØŒ Ù„Ø°Ù„Ùƒ Ø³ÙŠØ¸Ù‡Ø± â€œÙ…Ø¹Ù„Ù‚â€.
        <br><br>
        <b>Ø§Ù„Ø­Ù„:</b>
        <ol style="margin:8px 0 0;padding-right:18px">
          <li>Ù†Ø²Ù‘Ù„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ</li>
          <li>Ø§ÙØªØ­ <b>Chrome</b> â†’ Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· â†’ <b>ÙØªØ­ Ù…Ù„Ù</b> (Ø£Ùˆ Ø§ÙØªØ­Ù‡ Ù…Ù† â€œØ§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øªâ€ ÙÙŠ Chrome)</li>
          <li>Ø£Ùˆ Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ <b>Netlify</b> ÙˆØ§ÙØªØ­Ù‡ ÙƒØ±Ø§Ø¨Ø·</li>
        </ol>
      </div>
    </div>
  </div>
</noscript>

<header class="no-print" id="appHeader">
  <div class="container">
    <div class="brand">
      <div>
        <h1>ğŸ“¶ WiFi Accounting</h1>
        <div class="pill">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø¹ØµØ±ÙŠ Ù„Ø´Ø±ÙƒØ© Ø¥Ù†ØªØ±Ù†Øª (Ø²Ø¨Ø§ÙŠÙ† â€¢ Ø¨Ø§Ù‚Ø§Øª â€¢ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª â€¢ Ø¥ÙŠØµØ§Ù„Ø§Øª â€¢ Ø¯ÙØ¹Ø§Øª)</div>
      </div>
      <div>
        <span id="authState" class="badge b-warn">ØªØ­Ù…ÙŠÙ„...</span>
        <span id="miniStats" class="badge" style="margin-inline-start:8px">â€”</span>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="dashboard" type="button" onclick="setTab('dashboard')">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="tab" data-tab="customers" type="button" onclick="setTab('customers')">Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</button>
      <button class="tab" data-tab="plans" type="button" onclick="setTab('plans')">Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</button>
      <button class="tab" data-tab="subs" type="button" onclick="setTab('subs')">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button>
      <button class="tab" data-tab="countdown" type="button" onclick="setTab('countdown')">Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯</button>
      <button class="tab" data-tab="invoices" type="button" onclick="setTab('invoices')">Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</button>
      <button class="tab" data-tab="settings" type="button" onclick="setTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>
</header>

<main id="appMain">
  <div class="container">

    <!-- Stats (ØªØ®ØªÙÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø´Ø§Ø´Ø©) -->
    <div class="row stats no-print" style="margin-bottom:12px">
      <div class="stat"><div class="k">Ø¹Ø¯Ø¯ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</div><div class="v" id="statCustomers">â€”</div></div>
      <div class="stat"><div class="k">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙØ¹Ù‘Ø§Ù„Ø©</div><div class="v" id="statActiveSubs">â€”</div></div>
      <div class="stat"><div class="k">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div><div class="v" id="statMonthly">â€”</div></div>
      <div class="stat"><div class="k">Ø¥ÙŠØµØ§Ù„Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©/Ø¬Ø²Ø¦ÙŠØ©</div><div class="v" id="statOpenInv">â€”</div></div>
    </div>

    <div class="grid">
      <!-- Left panel (hidden on mobile) -->
      <section class="card no-print" id="leftPanel">
        <div class="hd">
          <h2 id="leftTitle">â€”</h2>
          <span class="tiny" id="leftHint">â€”</span>
        </div>
        <div class="bd" id="leftBody"></div>
      </section>

      <!-- Main panel -->
      <section class="card" id="mainPanel">
        <div class="hd no-print">
          <h2 id="mainTitle">â€”</h2>
          <div class="search">
            <input id="q" placeholder="Ø¨Ø­Ø« Ø´Ø§Ù…Ù„: Ø§Ø³Ù…ØŒ Ù‡Ø§ØªÙØŒ Ù…Ù†Ø·Ù‚Ø©ØŒ ÙŠÙˆØ²Ø±..." oninput="renderCurrent()">
            <button class="btn addMobile primary" type="button" onclick="openQuickAdd()">ï¼‹ Ø¥Ø¶Ø§ÙØ©</button>
            <button class="btn" type="button" onclick="reloadAll(true)">ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>
        <div class="bd" id="mainBody">
  <div style="padding:14px">
    <div class="badge b-warn">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div class="hr"></div>
    <div class="tiny muted">
      Ø¥Ø°Ø§ ÙØªØ­Øª Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø© (Ù…Ø«Ù„ Google Drive/Telegram/Ù…Ø¯ÙŠØ± Ù…Ù„ÙØ§Øª) Ù…Ù…ÙƒÙ† ÙŠÙˆÙ‚Ù JavaScript ÙÙŠØ¸Ù‡Ø± â€œÙ…Ø¹Ù„Ù‚â€.
      Ø§ÙØªØ­Ù‡ Ø¹Ø¨Ø± <b>Google Chrome</b> Ø£Ùˆ Ø§Ø±ÙØ¹Ù‡ Ø¹Ù„Ù‰ Netlify.
    </div>
  </div>
</div>
      </section>
    </div>
  </div>
</main>

<!-- QUICK ADD MODAL (for mobile) -->
<div class="overlay" id="formModal">
  <div class="box">
    <div class="hd no-print">
      <b id="formModalTitle">Ø¥Ø¶Ø§ÙØ©</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" type="button" onclick="closeFormModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="bd" id="formModalBody"></div>
  </div>
</div>

<!-- CUSTOMER MODAL -->
<div class="overlay" id="custModal">
  <div class="box">
    <div class="hd no-print">
      <b id="custModalTitle">Ù…Ù„Ù Ø§Ù„Ø²Ø¨ÙˆÙ†</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn danger" type="button" onclick="deleteCustomer(currentCustomerId)">Ø­Ø°Ù Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
        <button class="btn" type="button" onclick="closeCustomerModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="bd" id="custModalBody"></div>
  </div>
</div>

<!-- RECEIPT FULLSCREEN -->
<div class="invpage" id="invPage">
  <div class="invbar no-print">
    <div class="title" id="invPageTitle">Ø¥ÙŠØµØ§Ù„</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" type="button" onclick="setPrintModeAndPrint('a4')">ğŸ–¨ï¸ A4 (5 Ø¥ÙŠØµØ§Ù„Ø§Øª/ÙˆØ±Ù‚Ø©)</button>
      <button class="btn" type="button" onclick="setPrintModeAndPrint('pos')">ğŸ§¾ POS 80mm</button>
      <button class="btn danger" type="button" onclick="deleteInvoice(currentInvoiceId)">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      <button class="btn" type="button" onclick="closeInvoicePage()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <div class="invcontent" id="invContent">
    <div id="invoiceStage">
      <div id="invoiceView"></div>
    </div>
  </div>
</div>

<!-- BULK PRINT -->
<div id="printArea"></div>

<!-- âœ… Load Supabase right before app script (best for websites) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* =========================
   SUPABASE CONFIG (Ø¹Ø¯Ù„ ÙÙ‚Ø· Ù‡Ù†Ø§)
   ========================= */
const SUPABASE_URL = "https://qdzpyimpghxdgkzqrbvo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkenB5aW1wZ2h4ZGdrenFyYnZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4Mjg3MjUsImV4cCI6MjA4NjQwNDcyNX0.JHDxrsRb3IvnTRZk53WBt_8HZlUPFINTVhYFtc9F694";

let sb = null;

/* =========================
   STATE
   ========================= */
let TAB = "dashboard";
let settings = null;
let customers = [];
let plans = [];
let subs = [];
let invoices = []; // (Ù†ÙØ³ Ø¬Ø¯ÙˆÙ„ invoices Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±) Ù„ÙƒÙ† Ù†Ø³Ù…ÙŠÙ‡Ø§ "Ø¥ÙŠØµØ§Ù„Ø§Øª" Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
let lastLoadedAt = 0;

let currentInvoiceId = null;
let currentCustomerId = null;

let lastReceiptData = null; // {inv, items, pays}

let customerSeqMap = new Map(); // id -> 1..n
let invoiceNoOffset = 0;        // display offset for 1..n
let countdownTimer = null;

let printMode = "a4";           // 'a4' | 'pos'
let bulkSelection = new Set();  // invoice IDs

const $ = (id)=>document.getElementById(id);

/* âœ… FIX: robust HTML escaping */
function esc(s){
  const map = {
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    '"':"&quot;",
    "'":"&#39;"
  };
  return String(s ?? "").replace(/[&<>"']/g, (m)=>map[m]);
}

function money(n){
  if(n===null || n===undefined || isNaN(Number(n))) n = 0;
  const s = (Math.round(Number(n)*100)/100).toString();
  return (s.includes('.') ? s.replace(/\.0+$/,'').replace(/(\.\d*[1-9])0$/,'$1') : s);
}
function toast(msg){
  try{
    const el = document.getElementById("snackbar");
    if(el){
      el.textContent = String(msg||"");
      el.classList.add("show");
      clearTimeout(window.__snackT);
      window.__snackT = setTimeout(()=>el.classList.remove("show"), 4200);
      return;
    }
  }catch(e){}
  alert(msg);
}

function statusBadge(st){
  if(st==="paid") return `<span class="badge b-ok">paid</span>`;
  if(st==="partial") return `<span class="badge b-warn">partial</span>`;
  if(st==="void") return `<span class="badge">void</span>`;
  return `<span class="badge b-danger">unpaid</span>`;
}
function badgeDays(days){
  if(days === null || days === undefined) return `<span class="badge">â€”</span>`;
  if(days <= 0) return `<span class="badge b-danger">Ù…Ù†ØªÙ‡ÙŠ</span>`;
  if(days <= 3) return `<span class="badge b-danger">${days} ÙŠÙˆÙ…</span>`;
  if(days <= 7) return `<span class="badge b-warn">${days} ÙŠÙˆÙ…</span>`;
  return `<span class="badge b-ok">${days} ÙŠÙˆÙ…</span>`;
}

/* =========================
   Fix header height -> main top
   ========================= */
function updateHeaderH(){
  const h = document.getElementById("appHeader")?.offsetHeight || 150;
  document.documentElement.style.setProperty("--headerH", h+"px");
}
window.addEventListener("resize", ()=>{ updateHeaderH(); fitInvoiceToViewport(); });
window.addEventListener("orientationchange", ()=> setTimeout(()=>{ updateHeaderH(); fitInvoiceToViewport(); }, 250));

/* =========================
   Local receipt screen prefs (per device)
   ========================= */
const PREF_KEY = "wifi_receipt_screen_prefs_v2";
function getPrefs(){
  const d = { invW: 760, invH: 280 }; // default: receipt strip // default good for phone
  try{
    const x = JSON.parse(localStorage.getItem(PREF_KEY)||"null");
    if(x && Number(x.invW)>0 && Number(x.invH)>0) return { invW:Number(x.invW), invH:Number(x.invH) };
  }catch(e){}
  return d;
}
function savePrefs(invW, invH){
  localStorage.setItem(PREF_KEY, JSON.stringify({ invW:Number(invW), invH:Number(invH) }));
}

/* =========================
   Pack/unpack invoice item
   ========================= */
function packItem(planName, monthLabel, note){
  return "@wifi_item:" + JSON.stringify({ plan: planName||"", month: monthLabel||"", note: note||"" });
}
function unpackItem(desc){
  const s = String(desc || "");
  if(s.startsWith("@wifi_item:")){
    try{ return JSON.parse(s.slice(10)); }catch(e){}
  }
  return { plan: s, month: "", note: "" };
}

/* =========================
   Seq computations
   ========================= */
function computeCustomerSeq(){
  customerSeqMap = new Map();
  const sorted = [...customers].sort((a,b)=>{
    const aa = a.created_at ? new Date(a.created_at).getTime() : 0;
    const bb = b.created_at ? new Date(b.created_at).getTime() : 0;
    return aa - bb;
  });
  sorted.forEach((c, idx)=> customerSeqMap.set(c.id, idx+1));
}
function computeInvoiceOffset(){
  const nums = invoices.map(i=>Number(i.invoice_no)).filter(n=>Number.isFinite(n));
  if(!nums.length){ invoiceNoOffset = 0; return; }
  const min = Math.min(...nums);
  invoiceNoOffset = (min >= 1000) ? (min - 1) : 0;
}
function invPublicNo(invoice_no){
  const n = Number(invoice_no);
  if(!Number.isFinite(n)) return "â€”";
  return String(n - invoiceNoOffset);
}

/* =========================
   LOADERS
   ========================= */
async function loadSettings(){
  const { data, error } = await sb.from("settings").select("*").order("created_at",{ascending:true}).limit(1);
  if(error) throw error;
  settings = data?.[0] || null;
}
async function loadCustomers(){
  const { data, error } = await sb.from("customers").select("*").order("created_at",{ascending:false});
  if(error) throw error;
  customers = data || [];
  computeCustomerSeq();
}
async function loadPlans(){
  const { data, error } = await sb.from("plans").select("*").order("created_at",{ascending:false});
  if(error) throw error;
  plans = data || [];
}
async function loadSubs(){
  const { data, error } = await sb.from("v_subscriptions_status").select("*").order("created_at",{ascending:false});
  if(error) throw error;
  subs = data || [];
}
async function loadInvoices(){
  const { data, error } = await sb.from("invoices").select("*").order("created_at",{ascending:false}).limit(500);
  if(error) throw error;
  invoices = data || [];
  computeInvoiceOffset();
}

async function reloadAll(force=false){
  try{
    $("authState").textContent = "ØªØ­Ù…ÙŠÙ„...";
    await loadSettings();
    await loadCustomers();
    await loadPlans();
    await loadSubs();
    await loadInvoices();
    lastLoadedAt = Date.now();
    $("authState").textContent = "Ø¬Ø§Ù‡Ø² âœ…";
    renderStats();
    renderCurrent();
    startCountdownLoop();
    updateHeaderH();
  }catch(e){
    console.error(e);
    $("authState").textContent = "Ù…Ø´ÙƒÙ„Ø© âš ï¸";
    toast("Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + (e?.message||e));
    renderCurrent();
    updateHeaderH();
  }
}

function renderStats(){
  $("statCustomers").textContent = String(customers.length);
  const activeSubs = subs.filter(s=>s.status==="active").length;
  $("statActiveSubs").textContent = String(activeSubs);

  const monthly = subs
    .filter(s=>s.status==="active")
    .reduce((a,s)=>a + Number(s.monthly_price||0), 0);

  $("statMonthly").textContent = money(monthly) + " " + (settings?.currency||"USD");

  const openInv = invoices.filter(i=>i.status!=="paid" && i.status!=="void").length;
  $("statOpenInv").textContent = String(openInv);

  $("miniStats").textContent = `Ø²Ø¨Ø§ÙŠÙ†: ${customers.length} â€¢ ÙØ¹Ù‘Ø§Ù„: ${activeSubs} â€¢ Ø¥ÙŠØµØ§Ù„Ø§Øª: ${invoices.length}`;
}

/* =========================
   UI: Tabs
   ========================= */
function setTab(t){
  TAB = t;
  document.querySelectorAll(".tab").forEach(b=> b.classList.toggle("active", b.dataset.tab===TAB));
  renderCurrent();
}

function matchesQuery(obj, q){
  if(!q) return true;
  q = q.toLowerCase();
  const s = JSON.stringify(obj||{}).toLowerCase();
  return s.includes(q);
}

/* =========================
   QUICK ADD (Mobile)
   ========================= */
function openFormModal(title, html){
  $("formModalTitle").textContent = title;
  $("formModalBody").innerHTML = html;
  $("formModal").classList.add("show");
}
function closeFormModal(){
  $("formModal").classList.remove("show");
  $("formModalBody").innerHTML = "";
}
function openQuickAdd(){
  if(TAB==="dashboard" || TAB==="customers"){
    openFormModal("Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†", customerFormHTML());
    return;
  }
  if(TAB==="plans"){
    openFormModal("Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø©", planFormHTML());
    return;
  }
  if(TAB==="subs"){
    openFormModal("ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ", subFormHTML());
    return;
  }
  if(TAB==="invoices"){
    openFormModal("Ø¥Ù†Ø´Ø§Ø¡ Ø¥ÙŠØµØ§Ù„", invoiceFormHTML());
    return;
  }
  if(TAB==="settings"){
    openFormModal("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", settingsFormHTML());
    return;
  }
  if(TAB==="countdown"){
    openFormModal("Ù…Ù„Ø§Ø­Ø¸Ø©", `
      <div class="badge b-ok">Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯</div>
      <div class="hr"></div>
      <div class="tiny muted">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„ÙØªØ­ Ù…Ù„ÙÙ‡.</div>
      <div class="hr"></div>
      <button class="btn ok" type="button" onclick="reloadAll(true); closeFormModal();">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
    `);
    return;
  }
}

/* =========================
   FORMS
   ========================= */
function customerFormHTML(){
  return `
    <label>Ø§Ù„Ø§Ø³Ù…</label><input id="c_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
    <div class="split">
      <div><label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><input id="c_area" placeholder="Ø·Ø±Ø§Ø¨Ù„Ø³ / Ø¨ÙŠØ±ÙˆØª ..."></div>
      <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="c_phone" placeholder="70xxxxxx"></div>
    </div>
    <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="c_address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ">
    <div class="split">
      <div><label>Ø§Ù„ÙŠÙˆØ²Ø±</label><input id="c_user" placeholder="username"></div>
      <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="c_notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" type="button" onclick="addCustomer()">Ø­ÙØ¸ Ø²Ø¨ÙˆÙ†</button>
    </div>
    <div class="hr"></div>
    <div class="tiny">Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (1,2,3...)</div>
  `;
}

function planFormHTML(){
  return `
    <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©</label><input id="p_name" placeholder="Ù…Ø«Ø§Ù„: GB 10 Ø£Ùˆ 20Mbps">
    <div class="split">
      <div><label>Ø§Ù„Ø³Ø±Ø¹Ø©/Ø§Ù„Ù†ÙˆØ¹</label><input id="p_speed" placeholder="10Mbps / GB 10 ..."></div>
      <div><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</label><input id="p_price" type="number" step="0.01" placeholder="20"></div>
    </div>
    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="p_notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" type="button" onclick="addPlan()">Ø­ÙØ¸ Ø¨Ø§Ù‚Ø©</button>
    </div>
  `;
}

function subFormHTML(){
  const custOpts = customers.map(c=>{
    const no = customerSeqMap.get(c.id) || "";
    return `<option value="${c.id}">#${no} â€” ${esc(c.full_name)} â€” ${esc(c.phone||"")}</option>`;
  }).join("");

  const planOpts = plans
    .filter(p=>p.is_active !== false)
    .map(p=>`<option value="${p.id}" data-price="${p.monthly_price}">${esc(p.name)} â€” ${money(p.monthly_price)} ${(settings?.currency||"USD")}</option>`)
    .join("");

  return `
    <label>Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
    <select id="s_customer">${custOpts || `<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù†</option>`}</select>

    <label>Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
    <select id="s_plan" onchange="syncPlanPrice()">${planOpts || `<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª</option>`}</select>

    <div class="split">
      <div><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label><input id="s_price" type="number" step="0.01" placeholder="20"></div>
      <div><label>Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label><input id="s_days" type="number" value="30"></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" type="button" onclick="activateSub()">ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ</button>
    </div>
  `;
}

function invoiceFormHTML(){
  const custOpts = customers.map(c=>{
    const no = customerSeqMap.get(c.id) || "";
    return `<option value="${c.id}">#${no} â€” ${esc(c.full_name)} â€” ${esc(c.phone||"")}</option>`;
  }).join("");

  const planOpts = plans
    .filter(p=>p.is_active !== false)
    .map(p=>`<option value="${esc(p.name)}" data-price="${p.monthly_price||0}">${esc(p.name)} (${money(p.monthly_price||0)} ${(settings?.currency||"USD")})</option>`)
    .join("");

  const monthOpts = [
    "Ø§Ù„Ø´Ù‡Ø± 1 (Ø§Ù„Ø£ÙˆÙ„)","Ø§Ù„Ø´Ù‡Ø± 2 (Ø§Ù„Ø«Ø§Ù†ÙŠ)","Ø§Ù„Ø´Ù‡Ø± 3 (Ø§Ù„Ø«Ø§Ù„Ø«)","Ø§Ù„Ø´Ù‡Ø± 4 (Ø§Ù„Ø±Ø§Ø¨Ø¹)",
    "Ø§Ù„Ø´Ù‡Ø± 5 (Ø§Ù„Ø®Ø§Ù…Ø³)","Ø§Ù„Ø´Ù‡Ø± 6 (Ø§Ù„Ø³Ø§Ø¯Ø³)","Ø§Ù„Ø´Ù‡Ø± 7 (Ø§Ù„Ø³Ø§Ø¨Ø¹)","Ø§Ù„Ø´Ù‡Ø± 8 (Ø§Ù„Ø«Ø§Ù…Ù†)",
    "Ø§Ù„Ø´Ù‡Ø± 9 (Ø§Ù„ØªØ§Ø³Ø¹)","Ø§Ù„Ø´Ù‡Ø± 10 (Ø§Ù„Ø¹Ø§Ø´Ø±)","Ø§Ù„Ø´Ù‡Ø± 11 (Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±)","Ø§Ù„Ø´Ù‡Ø± 12 (Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±)"
  ].map(m=>`<option value="${m}">${m}</option>`).join("");

  const today = new Date().toISOString().slice(0,10);

  return `
    <label>Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
    <select id="i_customer">${custOpts || `<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù†</option>`}</select>

    <div class="split">
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
        <select id="i_plan" onchange="syncInvoiceAmount()">
          <option value="">Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø©...</option>
          ${planOpts}
        </select>
        <div class="tiny">Ø£Ùˆ Ø§ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠ:</div>
        <input id="i_plan_manual" placeholder="Ù…Ø«Ø§Ù„: GB 10">
      </div>
      <div>
        <label>Ø¹Ù† Ø£ÙŠ Ø´Ù‡Ø±</label>
        <select id="i_month">${monthOpts}</select>
        <div class="tiny">Ø£Ùˆ Ø§ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠ:</div>
        <input id="i_month_manual" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù‡Ø± 2">
      </div>
    </div>

    <div class="split">
      <div><label>Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</label><input id="i_amount" type="number" step="0.01" placeholder="20" oninput="syncPaidFromAmount()"></div>
      <div><label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input id="i_paid" type="number" step="0.01" placeholder="20"></div>
      <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label><input id="i_date" type="date" value="${today}"></div>
    </div>
    <div class="tiny muted">Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ Ø¥ÙŠØµØ§Ù„ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ Ø®Ù„ÙŠ "Ø§Ù„Ù…Ø¯ÙÙˆØ¹" = 0.</div>

    <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="i_note" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙØ¹Ø© Ù…ØªØ£Ø®Ø±Ø© / Ø®ØµÙ… ...">

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" type="button" onclick="createInvoice()">Ø¥Ù†Ø´Ø§Ø¡ Ø¥ÙŠØµØ§Ù„</button>
    </div>

    <div class="hr"></div>
    <div class="tiny muted">
      âœ… Ø·Ø¨Ø§Ø¹Ø© A4: ÙƒÙ„ ÙˆØ±Ù‚Ø© ÙÙŠÙ‡Ø§ 5 Ø¥ÙŠØµØ§Ù„Ø§Øª â€” ÙˆÙƒÙ„ Ø¥ÙŠØµØ§Ù„ Ù†Ø³Ø®ØªÙŠÙ† (Ø´Ø±ÙƒØ©/Ø²Ø¨ÙˆÙ†).
    </div>
  `;
}

function settingsFormHTML(){
  const prefs = getPrefs();
  return `
    <div class="badge b-ok">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© (ØªÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±)</div>

    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="set_name" value="${esc(settings?.company_name||"WiFi Company")}">
    <div class="split">
      <div><label>Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="set_phone" value="${esc(settings?.company_phone||"")}"></div>
      <div><label>Ø§Ù„Ø¹Ù…Ù„Ø©</label><input id="set_cur" value="${esc(settings?.currency||"USD")}"></div>
    </div>
    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="set_addr" value="${esc(settings?.company_address||"")}">

    <div class="split">
      <div>
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØºÙˆ (URL) Ø£Ùˆ DataURL</label>
        <input id="set_logo" value="${esc(settings?.company_logo_url||"")}" placeholder="https://.../logo.png">
        <div class="tiny muted">ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù„ÙˆØºÙˆ ÙƒÙ€ Data URL Ù…Ù† Ø²Ø± Ø§Ù„Ø±ÙØ¹.</div>
      </div>
      <div>
        <label>Ø±ÙØ¹ Ù„ÙˆØºÙˆ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="set_logo_file" type="file" accept="image/*" onchange="handleLogoUpload(this)">
        <div class="tiny muted">Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙˆØ¶Ø¹Ù‡ Ø¨Ø§Ù„Ø­Ù‚Ù„.</div>
      </div>
    </div>

    <div class="split">
      <div>
        <label>Prefix Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
        <input id="set_pref" value="${esc(settings?.invoice_prefix||"REC")}">
      </div>
      <div><label class="muted">Ù…Ø«Ø§Ù„</label><input disabled value="${esc((settings?.invoice_prefix||'REC'))}-1"></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" type="button" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div class="hr"></div>
    <div class="badge">Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù„Ù„Ø´Ø§Ø´Ø© (Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·)</div>

    <div class="split">
      <div><label>Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„ (px)</label><input id="pref_w" type="number" value="${prefs.invW}"></div>
      <div><label>Ø·ÙˆÙ„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ (px)</label><input id="pref_h" type="number" value="${prefs.invH}"></div>
    </div>
    <div class="tiny muted">Ù‡Ø¯ÙÙ†Ø§: Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙŠØ¸Ù‡Ø± ÙƒØ§Ù…Ù„ â€œØ´Ø§Ø´Ø© ÙˆØ­Ø¯Ø©â€ Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠØ±.</div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn ok" type="button" onclick="saveScreenPrefs()">Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³</button>
      <button class="btn" type="button" onclick="previewInvoiceSample()">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
    </div>
  `;
}

function settingsPreviewHTML(){
  const name = settings?.company_name || "WiFi Company";
  const phone = settings?.company_phone || "";
  const addr = settings?.company_address || "";
  const logo = settings?.company_logo_url || "";
  const prefs = getPrefs();
  return `
    <div class="badge b-ok">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
    <div class="hr"></div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      ${logo?`<img src="${esc(logo)}" style="width:64px;height:64px;object-fit:contain;border:1px solid var(--line);border-radius:14px;padding:6px">`:""}
      <div>
        <div style="font-size:18px"><b>${esc(name)}</b></div>
        <div class="tiny muted">${esc(addr)}</div>
        <div class="tiny muted">${esc(phone)}</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="tiny muted">Ù…Ù‚Ø§Ø³ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${prefs.invW}Ã—${prefs.invH}</b> px</div>
  `;
}

/* =========================
   PAGES
   ========================= */
function dashboardHTML(q){
  const exp = subs
    .filter(s=>matchesQuery(s,q))
    .filter(s=>s.status==="active")
    .sort((a,b)=>(a.days_left??999)-(b.days_left??999))
    .slice(0,120);

  const rows = exp.map(s=>{
    const cNo = customerSeqMap.get(s.customer_id) || "";
    return `
      <tr>
        <td>
          <b>#${cNo} â€” ${esc(s.full_name || "â€”")}</b>
          <div class="tiny muted">${esc(s.phone||"")} â€¢ ${esc(s.area||"")}</div>
          <div class="tiny">Ø¨Ø§Ù‚Ø©: <b>${esc(s.plan_name||"â€”")}</b> â€¢ Ø´Ù‡Ø±ÙŠ: <b>${money(s.monthly_price)} ${(settings?.currency||"USD")}</b></div>
        </td>
        <td>${badgeDays(s.days_left)}</td>
        <td class="no-print">
          <button class="btn" type="button" onclick="openCustomerModal('${s.customer_id}')">Ù…Ù„Ù Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
          <button class="btn ok" type="button" onclick="renewSub('${s.id}')">ØªØ¬Ø¯ÙŠØ¯ 30 ÙŠÙˆÙ…</button>
        </td>
      </tr>
    `;
  }).join("");

  return `
    <div class="pill2 b-warn">ØªÙ†Ø¨ÙŠÙ‡: Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ end_date ÙˆÙŠÙØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
    <div class="hr"></div>
    <table>
      <thead><tr><th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="3" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</td></tr>`}</tbody>
    </table>
  `;
}

function customersHTML(q){
  const rows = customers
    .filter(c=>matchesQuery(c,q))
    .map(c=>{
      const no = customerSeqMap.get(c.id) || "";
      return `
        <tr>
          <td>
            <b>#${no} â€” ${esc(c.full_name)}</b>
            <div class="tiny muted">${esc(c.phone||"")} â€¢ ${esc(c.area||"")}</div>
            <div class="tiny muted">${c.username ? ("ÙŠÙˆØ²Ø±: "+esc(c.username)) : ""}</div>
          </td>
          <td class="no-print">
            <button class="btn" type="button" onclick="openCustomerModal('${c.id}')">Ù…Ù„Ù</button>
            <button class="btn danger" type="button" onclick="deleteCustomer('${c.id}')">Ø­Ø°Ù</button>
          </td>
        </tr>
      `;
    }).join("");

  return `
    <table>
      <thead><tr><th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="2" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù†.</td></tr>`}</tbody>
    </table>
  `;
}

function plansHTML(q){
  const rows = plans
    .filter(p=>matchesQuery(p,q))
    .map(p=>`
      <tr>
        <td><b>${esc(p.name)}</b><div class="tiny muted">${esc(p.speed||"")}</div></td>
        <td><b>${money(p.monthly_price||0)} ${(settings?.currency||"USD")}</b></td>
        <td class="no-print">
          <button class="btn danger" type="button" onclick="deletePlan('${p.id}')">Ø­Ø°Ù</button>
        </td>
      </tr>
    `).join("");

  return `
    <table>
      <thead><tr><th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="3" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª.</td></tr>`}</tbody>
    </table>
  `;
}

function subsHTML(q){
  const rows = subs
    .filter(s=>matchesQuery(s,q))
    .map(s=>{
      const cNo = customerSeqMap.get(s.customer_id) || "";
      return `
        <tr>
          <td>
            <b>#${cNo} â€” ${esc(s.full_name||"â€”")}</b>
            <div class="tiny muted">${esc(s.phone||"")} â€¢ ${esc(s.area||"")}</div>
            <div class="tiny">Ø¨Ø§Ù‚Ø©: <b>${esc(s.plan_name||"â€”")}</b> â€¢ Ø´Ù‡Ø±ÙŠ: <b>${money(s.monthly_price)} ${(settings?.currency||"USD")}</b></div>
            <div class="tiny muted">Ù…Ù† ${esc(s.start_date||"")} Ø¥Ù„Ù‰ ${esc(s.end_date||"")} â€¢ Ø­Ø§Ù„Ø©: ${esc(s.status||"")}</div>
          </td>
          <td>${badgeDays(s.days_left)}</td>
          <td class="no-print">
            <button class="btn" type="button" onclick="openCustomerModal('${s.customer_id}')">Ù…Ù„Ù</button>
            <button class="btn ok" type="button" onclick="renewSub('${s.id}')">ØªØ¬Ø¯ÙŠØ¯ 30 ÙŠÙˆÙ…</button>
            <button class="btn danger" type="button" onclick="endSub('${s.id}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
          </td>
        </tr>
      `;
    }).join("");

  return `
    <table>
      <thead><tr><th>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody>${rows || `<tr><td colspan="3" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª.</td></tr>`}</tbody>
    </table>
  `;
}

function invoicesHTML(q){
  const cur = settings?.currency || "USD";
  const filtered = invoices.filter(i=>matchesQuery(i,q));

  const rows = filtered.map(i=>{
    const c = customers.find(x=>x.id===i.customer_id);
    const cNo = c ? (customerSeqMap.get(c.id)||"") : "";
    const name = c?.full_name || "â€”";
    const invCode = `${settings?.invoice_prefix||"REC"}-${invPublicNo(i.invoice_no)}`;
    const st = i.status || "unpaid";
    const total = Number(i.total ?? i.subtotal ?? 0);
    const paid = Number(i.paid ?? 0);
    const balance = Number(i.balance ?? (total - paid));
    const checked = bulkSelection.has(i.id) ? "checked" : "";

    return `
      <tr>
        <td class="no-print" style="width:44px">
          <input type="checkbox" ${checked} onchange="toggleBulk('${i.id}', this.checked)">
        </td>
        <td>
          <b>${esc(invCode)}</b>
          <div class="tiny muted">${esc(i.issue_date||"")} â€¢ #${cNo} â€” ${esc(name)}</div>
          <div class="tiny">
            Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${money(total)} ${esc(i.currency||cur)}</b>
            â€¢ Ù…Ø¯ÙÙˆØ¹: <b>${money(paid)}</b>
            â€¢ Ù…ØªØ¨Ù‚Ù‘ÙŠ: <b>${money(balance)}</b>
          </div>
        </td>
        <td>${statusBadge(st)}</td>
        <td class="no-print" style="white-space:nowrap">
          <button class="btn" type="button" onclick="openInvoiceFromList(event,'${i.id}', this)">Ø¹Ø±Ø¶/Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn ok" type="button" onclick="addPaymentPrompt('${i.id}')">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
          <button class="btn danger" type="button" onclick="deleteInvoice('${i.id}')">Ø­Ø°Ù</button>
        </td>
      </tr>
    `;
  }).join("");

  return `
    <div class="no-print" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
      <button class="btn primary" type="button" onclick="bulkPrint('a4')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© A4 (5/ÙˆØ±Ù‚Ø©)</button>
      <button class="btn primary" type="button" onclick="bulkPrint('pos')">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© POS</button>
      <button class="btn" type="button" onclick="selectFilteredInvoices(30)">âœ“ ØªØ­Ø¯ÙŠØ¯ Ø£ÙˆÙ„ 30</button>
      <button class="btn" type="button" onclick="clearBulk()">Ù…Ø³Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
      <span class="tiny muted">Ù…Ø­Ø¯Ø¯: <b>${bulkSelection.size}</b> â€¢ Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ ÙƒÙ…Ø¨ÙŠÙˆØªØ±.</span>
    </div>

    <table>
      <thead>
        <tr>
          <th class="no-print">âœ“</th>
          <th>Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody>${rows || `<tr><td colspan="4" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª.</td></tr>`}</tbody>
    </table>
  `;
}

function countdownHTML(q){
  const list = subs
    .filter(s=>matchesQuery(s,q))
    .filter(s=>s.status==="active")
    .sort((a,b)=>{
      const da = new Date(a.end_date||0).getTime();
      const db = new Date(b.end_date||0).getTime();
      return da - db;
    });

  const cards = list.map(s=>{
    const cNo = customerSeqMap.get(s.customer_id) || "";
    const end = s.end_date ? new Date(s.end_date + "T23:59:59").getTime() : 0;

    const plan = s.plan_name || "â€”";
    const price = money(s.monthly_price||0);
    const cur = settings?.currency || "USD";

    const bg = brightGradient(s.customer_id || s.id);

    return `
      <div class="ccard" onclick="openCustomerModal('${s.customer_id}')" data-end="${end}" data-sub="${esc(s.id)}"
        style="background:${bg}">
        <div class="top">
          <div>
            <div class="name">#${cNo} â€” ${esc(s.full_name||"â€”")}</div>
            <div class="meta tiny muted">${esc(s.phone||"")} â€¢ ${esc(s.area||"")}</div>
            <div class="meta tiny">Ø¨Ø§Ù‚Ø©: <b>${esc(plan)}</b> â€¢ Ø´Ù‡Ø±ÙŠ: <b>${price} ${cur}</b></div>
          </div>
          <div>${badgeDays(s.days_left)}</div>
        </div>

        <div class="countdown" id="cd_${esc(s.id)}">
          <div class="cd"><div class="n">â€”</div><div class="t">Ø£ÙŠØ§Ù…</div></div>
          <div class="cd"><div class="n">â€”</div><div class="t">Ø³Ø§Ø¹Ø§Øª</div></div>
          <div class="cd"><div class="n">â€”</div><div class="t">Ø¯Ù‚Ø§Ø¦Ù‚</div></div>
          <div class="cd"><div class="n">â€”</div><div class="t">Ø«ÙˆØ§Ù†ÙŠ</div></div>
        </div>

        <div class="hr"></div>
        <div class="tiny muted">ÙŠÙ†ØªÙ‡ÙŠ: ${esc(s.end_date||"â€”")} â€¢ Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</div>
      </div>
    `;
  }).join("");

  return `
    <div class="pill2 b-ok">Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ø¶Ø­Ø© (Ø£ÙŠØ§Ù… â€¢ Ø³Ø§Ø¹Ø§Øª â€¢ Ø¯Ù‚Ø§Ø¦Ù‚ â€¢ Ø«ÙˆØ§Ù†ÙŠ)</div>
    <div class="hr"></div>
    <div class="cards">${cards || `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙØ¹Ù‘Ø§Ù„Ø©.</div>`}</div>
  `;
}

/* bright gradients */
function brightGradient(seed){
  const palettes = [
    ["#dbeafe","#93c5fd"], // blue
    ["#dcfce7","#86efac"], // green
    ["#ffedd5","#fdba74"], // orange
    ["#ede9fe","#c4b5fd"], // purple
    ["#cffafe","#67e8f9"], // cyan
    ["#ffe4e6","#fda4af"], // pink
  ];
  let h=0; const s=String(seed||"x");
  for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))>>>0;
  const p = palettes[h % palettes.length];
  return `linear-gradient(135deg, ${p[0]}, ${p[1]})`;
}

/* =========================
   RENDER CURRENT
   ========================= */
function renderCurrent(){
  const q = $("q").value.trim();

  if(TAB==="dashboard"){
    $("leftTitle").textContent = "Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†";
    $("leftHint").textContent = "Ø£Ø¶Ù Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯ Ø¨Ø³Ø±Ø¹Ø©";
    $("mainTitle").textContent = "ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ";
    $("leftBody").innerHTML = customerFormHTML();
    $("mainBody").innerHTML = dashboardHTML(q);
    return;
  }
  if(TAB==="customers"){
    $("leftTitle").textContent = "Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†";
    $("leftHint").textContent = "Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ";
    $("mainTitle").textContent = "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†";
    $("leftBody").innerHTML = customerFormHTML();
    $("mainBody").innerHTML = customersHTML(q);
    return;
  }
  if(TAB==="plans"){
    $("leftTitle").textContent = "Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø©";
    $("leftHint").textContent = "Ø­Ø¯Ø¯ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø§Ø³Ù…";
    $("mainTitle").textContent = "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª";
    $("leftBody").innerHTML = planFormHTML();
    $("mainBody").innerHTML = plansHTML(q);
    return;
  }
  if(TAB==="subs"){
    $("leftTitle").textContent = "ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ";
    $("leftHint").textContent = "Ø¨Ø¯Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø©";
    $("mainTitle").textContent = "Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª";
    $("leftBody").innerHTML = subFormHTML();
    $("mainBody").innerHTML = subsHTML(q);
    return;
  }
  if(TAB==="countdown"){
    $("leftTitle").textContent = "Ù…Ù„Ø§Ø­Ø¸Ø©";
    $("leftHint").textContent = "Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ø²Ø¨ÙˆÙ†";
    $("mainTitle").textContent = "Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯";
    $("leftBody").innerHTML = `
      <div class="badge b-ok">Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯</div>
      <div class="hr"></div>
      <div class="tiny muted">
        Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹ØµØ±ÙŠØ© ÙˆÙˆØ§Ø¶Ø­Ø©<br>(Ø£ÙŠØ§Ù… â€¢ Ø³Ø§Ø¹Ø§Øª â€¢ Ø¯Ù‚Ø§Ø¦Ù‚ â€¢ Ø«ÙˆØ§Ù†ÙŠ)
      </div>
      <div class="hr"></div>
      <button class="btn ok" type="button" onclick="reloadAll(true)">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
    `;
    $("mainBody").innerHTML = countdownHTML(q);
    return;
  }
  if(TAB==="invoices"){
    $("leftTitle").textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø¥ÙŠØµØ§Ù„";
    $("leftHint").textContent = "Ø¨Ø§Ù‚Ø© + Ø´Ù‡Ø± + Ù…Ø¨Ù„Øº + Ù…Ù„Ø§Ø­Ø¸Ø©";
    $("mainTitle").textContent = "Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª";
    $("leftBody").innerHTML = invoiceFormHTML();
    $("mainBody").innerHTML = invoicesHTML(q);
    return;
  }
  if(TAB==="settings"){
    $("leftTitle").textContent = "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
    $("leftHint").textContent = "Ø´Ø±ÙƒØ© + Ù„ÙˆØºÙˆ + Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¥ÙŠØµØ§Ù„";
    $("mainTitle").textContent = "Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©";
    $("leftBody").innerHTML = settingsFormHTML();
    $("mainBody").innerHTML = settingsPreviewHTML();
    return;
  }
}

/* =========================
   ACTIONS
   ========================= */
async function addCustomer(){
  const payload = {
    full_name: $("c_name")?.value?.trim() || "",
    area: $("c_area")?.value?.trim() || "",
    address: $("c_address")?.value?.trim() || "",
    phone: $("c_phone")?.value?.trim() || "",
    username: $("c_user")?.value?.trim() || "",
    notes: $("c_notes")?.value?.trim() || ""
  };
  if(!payload.full_name) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†");
  const { error } = await sb.from("customers").insert(payload);
  if(error) return toast("Ø®Ø·Ø£ Ø­ÙØ¸ Ø²Ø¨ÙˆÙ†: " + error.message);
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²Ø¨ÙˆÙ† âœ…");
  closeFormModal();
  await reloadAll(true);
}

async function deleteCustomer(id){
  if(!id) return;
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ (Ù‚Ø¯ ÙŠÙØ­Ø°Ù Ù…Ø¹Ù‡ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª/Ø¥ÙŠØµØ§Ù„Ø§Øª Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)")) return;
  const { error } = await sb.from("customers").delete().eq("id", id);
  if(error) return toast("Ø®Ø·Ø£ Ø­Ø°Ù: " + error.message);
  closeCustomerModal();
  await reloadAll(true);
}

async function addPlan(){
  const payload = {
    name: $("p_name")?.value?.trim() || "",
    speed: $("p_speed")?.value?.trim() || "",
    monthly_price: Number($("p_price")?.value||0),
    notes: $("p_notes")?.value?.trim() || ""
  };
  if(!payload.name) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©");
  const { error } = await sb.from("plans").insert(payload);
  if(error) return toast("Ø®Ø·Ø£ Ø­ÙØ¸ Ø¨Ø§Ù‚Ø©: " + error.message);
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ù‚Ø© âœ…");
  closeFormModal();
  await reloadAll(true);
}

async function deletePlan(id){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù‚Ø©ØŸ")) return;
  const { error } = await sb.from("plans").delete().eq("id", id);
  if(error) return toast("Ø®Ø·Ø£ Ø­Ø°Ù: " + error.message);
  await reloadAll(true);
}

function syncPlanPrice(){
  const sel = $("s_plan");
  const opt = sel?.selectedOptions?.[0];
  const price = opt?.getAttribute("data-price");
  if(price!==null && price!==undefined && $("s_price")) $("s_price").value = price;
}

async function activateSub(){
  const customer_id = $("s_customer")?.value || "";
  const plan_id = $("s_plan")?.value || null;
  const monthly_price = Number($("s_price")?.value||0);
  const days = Number($("s_days")?.value||30);

  if(!customer_id) return toast("Ø§Ø®ØªØ± Ø§Ù„Ø²Ø¨ÙˆÙ†");
  if(!monthly_price) return toast("Ø­Ø¯Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ");

  const start = new Date();
  const end = new Date();
  end.setDate(end.getDate() + days);

  const payload = {
    customer_id,
    plan_id,
    monthly_price,
    start_date: start.toISOString().slice(0,10),
    end_date: end.toISOString().slice(0,10),
    status: "active",
    auto_renew: true
  };

  const { error } = await sb.from("subscriptions").insert(payload);
  if(error) return toast("Ø®Ø·Ø£ ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ: " + error.message);
  toast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ âœ…");
  closeFormModal();
  await reloadAll(true);
}

async function renewSub(subId){
  const s = subs.find(x=>x.id===subId);
  if(!s) return;
  const end = new Date(s.end_date);
  end.setDate(end.getDate() + 30);
  const { error } = await sb.from("subscriptions").update({ end_date: end.toISOString().slice(0,10), status:"active" }).eq("id", subId);
  if(error) return toast("Ø®Ø·Ø£ ØªØ¬Ø¯ÙŠØ¯: " + error.message);
  await reloadAll(true);
}

async function endSub(subId){
  if(!confirm("Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ")) return;
  const { error } = await sb.from("subscriptions").update({ status:"ended" }).eq("id", subId);
  if(error) return toast("Ø®Ø·Ø£ Ø¥Ù†Ù‡Ø§Ø¡: " + error.message);
  await reloadAll(true);
}

/* =========================
   RECEIPTS (Invoices table)
   ========================= */
function syncInvoiceAmount(){
  const sel = $("i_plan");
  const opt = sel?.selectedOptions?.[0];
  const price = opt?.getAttribute("data-price");
  if(price!==null && price!==undefined){
    if($("i_amount") && !$("i_amount").value) $("i_amount").value = price;
    if($("i_paid") && !$("i_paid").value) $("i_paid").value = $("i_amount")?.value || price;
  }
}

function syncPaidFromAmount(){
  // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ø¹Ø¯Ù‘Ù„ "Ø§Ù„Ù…Ø¯ÙÙˆØ¹" ÙŠØ¯ÙˆÙŠØŒ Ø®Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©
  const a = $("i_amount")?.value;
  const p = $("i_paid");
  if(!p) return;
  if(!p.dataset.touched){
    p.value = a;
  }
}

document.addEventListener("input", (e)=>{
  if(e?.target?.id === "i_paid"){
    e.target.dataset.touched = "1";
  }
});

async function getNextInvoiceNo(){
  const { data, error } = await sb
    .from("invoices")
    .select("invoice_no")
    .order("invoice_no", { ascending:false })
    .limit(1);
  if(error) throw error;
  const max = Number(data?.[0]?.invoice_no || 0);
  return max + 1; // Ù„Ùˆ Ø£ÙˆÙ„ Ù…Ø±Ø© => 1
}

async function createInvoice(){
  const customer_id = $("i_customer")?.value || "";
  const issue_date = $("i_date")?.value || "";
  const amount = Number($("i_amount")?.value||0);
  const paid_now = Number($("i_paid")?.value||0);
  const note = $("i_note")?.value?.trim() || "";

  const planSel = $("i_plan")?.value?.trim() || "";
  const planManual = $("i_plan_manual")?.value?.trim() || "";
  const planName = planManual || planSel;

  const monthSel = $("i_month")?.value?.trim() || "";
  const monthManual = $("i_month_manual")?.value?.trim() || "";
  const monthLabel = monthManual || monthSel;

  if(!customer_id) return toast("Ø§Ø®ØªØ± Ø§Ù„Ø²Ø¨ÙˆÙ†");
  if(!planName) return toast("Ø§Ø®ØªØ±/Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©");
  if(!monthLabel) return toast("Ø§Ø®ØªØ±/Ø§ÙƒØªØ¨ Ø¹Ù† Ø£ÙŠ Ø´Ù‡Ø±");
  if(!amount || amount<=0) return toast("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
  if(paid_now < 0) return toast("Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ØºÙŠØ± ØµØ­ÙŠØ­");

  const currency = settings?.currency || "USD";
  const invoice_no = await getNextInvoiceNo();

  const { data: inv, error: e1 } = await sb
    .from("invoices")
    .insert({
      customer_id,
      issue_date,
      due_date: issue_date,
      notes: "",
      currency,
      discount: 0,
      invoice_no
    })
    .select("*")
    .single();
  if(e1) return toast("Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø¥ÙŠØµØ§Ù„: " + e1.message);

  const description = packItem(planName, monthLabel, note);

  const { error: e2 } = await sb.from("invoice_items").insert({
    invoice_id: inv.id,
    description,
    qty: 1,
    unit_price: amount,
    sort_order: 1
  });
  if(e2) return toast("Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯: " + e2.message);

  // âœ… Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  if(paid_now > 0){
    const { error: ep } = await sb.from("payments").insert({
      invoice_id: inv.id,
      amount: paid_now,
      method: "cash",
      note: note || "",
      pay_date: issue_date
    });
    if(ep) return toast("Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹: " + ep.message);
  }

  await recalcInvoice(inv.id);
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥ÙŠØµØ§Ù„ âœ…");
  closeFormModal();
  await reloadAll(true);
  await openInvoice(inv.id);
}

async function recalcInvoice(invoiceId){
  const { data: items, error: e1 } = await sb.from("invoice_items").select("*").eq("invoice_id", invoiceId);
  if(e1) return;

  const { data: pays, error: e2 } = await sb.from("payments").select("*").eq("invoice_id", invoiceId);
  if(e2) return;

  const subtotal = (items||[]).reduce((a,it)=>{
    const line = (it.line_total!=null) ? Number(it.line_total||0) : (Number(it.qty||1)*Number(it.unit_price||0));
    return a + line;
  }, 0);

  const paid = (pays||[]).reduce((a,p)=>a + Number(p.amount||0), 0);

  const { data: inv, error: e3 } = await sb.from("invoices").select("*").eq("id", invoiceId).single();
  if(e3) return;

  const discount = Number(inv.discount||0);
  const total = subtotal - discount;
  const balance = total - paid;

  let status = inv.status || "unpaid";
  if(status !== "void"){
    if(total<=0) status = "paid";
    else if(balance <= 0) status = "paid";
    else if(paid > 0) status = "partial";
    else status = "unpaid";
  }

  await sb.from("invoices").update({ subtotal, discount, total, paid, balance, status }).eq("id", invoiceId);
}

async function addPaymentPrompt(invoiceId){
  const amount = prompt("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:");
  if(amount===null) return;
  const a = Number(amount);
  if(!a || a<=0) return toast("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­");

  const method = prompt("Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ØŸ (cash/transfer/card/other)", "cash") || "cash";
  const note = prompt("Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):", "") || "";

  const { error } = await sb.from("payments").insert({ invoice_id: invoiceId, amount: a, method, note });
  if(error) return toast("Ø®Ø·Ø£ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©: " + error.message);

  await recalcInvoice(invoiceId);
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø© âœ…");
  await reloadAll(true);
}

async function deleteInvoice(id){
  if(!id) return;
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡.")) return;

  await sb.from("payments").delete().eq("invoice_id", id);
  await sb.from("invoice_items").delete().eq("invoice_id", id);

  const { error } = await sb.from("invoices").delete().eq("id", id);
  if(error) return toast("Ø®Ø·Ø£ Ø­Ø°Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„: " + error.message);

  if(currentInvoiceId === id) closeInvoicePage();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„ âœ…");
  bulkSelection.delete(id);
  await reloadAll(true);
}

function openInvoicePage(){
  $("invPage").classList.add("show");
  requestAnimationFrame(()=> fitInvoiceToViewport());
  setTimeout(()=> fitInvoiceToViewport(), 250);
}
function closeInvoicePage(){
  $("invPage").classList.remove("show");
  currentInvoiceId = null;
  renderCurrent();
}

function openInvoiceFromList(ev, id, btn){
  if(ev){ ev.preventDefault(); ev.stopPropagation(); }
  if(btn){
    if(btn.dataset.loading==="1") return;
    btn.dataset.loading="1";
    const old = btn.textContent;
    btn.textContent = "ØªØ­Ù…ÙŠÙ„...";
    openInvoice(id).finally(()=>{
      btn.dataset.loading="0";
      btn.textContent = old;
    });
  }else{
    openInvoice(id);
  }
}

function fitInvoiceToViewport(){
  const page = $("invPage");
  if(!page || !page.classList.contains("show")) return;
  const stage = $("invoiceStage");
  if(!stage) return;

  stage.style.transform = "scale(1)";

  const bar = page.querySelector(".invbar");
  const barH = bar ? bar.offsetHeight : 0;

  const pad = 16;
  const availW = window.innerWidth - pad;
  const availH = window.innerHeight - barH - pad;

  const fullW = stage.offsetWidth;
  const fullH = stage.offsetHeight;
  if(!fullW || !fullH) return;

  let scale = Math.min(availW / fullW, availH / fullH);
  scale = Math.max(0.35, Math.min(scale, 2.2));
  stage.style.transform = `scale(${scale})`;
}

/* Print */
function applyPrintCSS(mode){
  const st = $("dynamicPrintStyle");

  if(mode==="pos"){
    st.textContent = `
      @page { size: 80mm auto; margin: 4mm; }
      body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .invpaper{ width: 80mm !important; }
      .pos-sep{ border-top:1px dashed rgba(15,23,42,.35); margin:6mm 0; }
    `;
    return;
  }

  /* âœ… A4: 5 receipts per page + 2 copies per receipt */
  st.textContent = `
    @page { size: A4 portrait; margin: 8mm; }
    body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .sheet{ width: 190mm; margin: 0 auto; }
    .receipt{ height: 54mm; border:1px solid rgba(15,23,42,.35); border-radius:8px; padding:3mm; margin-bottom:2mm; page-break-inside:avoid; overflow:hidden; }
    .receipt.empty{ border-color: transparent; }
    .receiptRow{ display:flex; height:100%; gap:0; }
    .copy{ flex:1; padding:0 2mm; font-size:10.5px; line-height:1.25; display:flex; flex-direction:column; }
    .copy + .copy{ border-inline-start:1px dashed rgba(15,23,42,.35); }
    .copyHd{ display:flex; align-items:flex-start; justify-content:space-between; gap:6px; }
    .copyTitle{ font-weight:900; font-size:12px; }
    .copyTag{ font-size:10px; border:1px solid rgba(15,23,42,.25); border-radius:999px; padding:1px 6px; white-space:nowrap; }
    .rline{ height:1px; background:rgba(15,23,42,.18); margin:2mm 0; }
    .rmuted{ color:#475569; font-size:10px; }
    .ramount{ font-weight:900; font-size:12px; }
    .sig{ margin-top:auto; display:flex; justify-content:space-between; gap:6px; font-size:10px; }
    .sig span{ border-top:1px solid rgba(15,23,42,.25); padding-top:2mm; width:46%; text-align:center; }
    .pageBreak{ page-break-after: always; height:0; }
  `;
}

function setPrintModeAndPrint(mode){
  printMode = mode;
  applyPrintCSS(mode);

  if(mode==="a4"){
    // âœ… Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¶Ù…Ù† A4 5-up (Ø­ØªÙ‰ Ù„Ùˆ Ø¥ÙŠØµØ§Ù„ ÙˆØ§Ø­Ø¯)
    printCurrentReceiptA4();
    return;
  }

  // POS: Ø§Ø·Ø¨Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Ù†Ø³Ø®ØªÙŠÙ† ÙÙˆÙ‚/ØªØ­Øª)
  if(mode==="pos" && lastReceiptData && $("invoiceView")){
    $("invoiceView").innerHTML = buildReceiptPaperHTML(
      lastReceiptData.inv,
      lastReceiptData.items,
      lastReceiptData.pays,
      { forPrint:false, mode:"pos" }
    );
    fitInvoiceToViewport();
  }

  requestAnimationFrame(()=>window.print());
}

/* ====== A4 helper (single receipt) ====== */
async function printCurrentReceiptA4(){
  if(!currentInvoiceId) return toast("Ø§ÙØªØ­ Ø¥ÙŠØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹.");
  const id = currentInvoiceId;

  const { data: inv, error: e1 } = await sb.from("invoices").select("*").eq("id", id).single();
  if(e1) return toast("Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„: " + e1.message);

  const { data: items, error: e2 } = await sb.from("invoice_items").select("*").eq("invoice_id", id).order("sort_order",{ascending:true});
  if(e2) return toast("Ø®Ø·Ø£ Ø¨Ù†ÙˆØ¯: " + e2.message);

  const { data: pays, error: e3 } = await sb.from("payments").select("*").eq("invoice_id", id).order("created_at",{ascending:true});
  if(e3) return toast("Ø®Ø·Ø£ Ø¯ÙØ¹Ø§Øª: " + e3.message);

  // build one receipt slip and fill up to 5 spots
  const slips = [buildReceiptSlipHTML(inv, items||[], pays||[])];
  while(slips.length < 5) slips.push(`<div class="receipt empty"></div>`);

  document.body.classList.add("bulk-printing");
  $("printArea").innerHTML = `<div class="sheet">${slips.join("")}</div>`;

  setTimeout(()=>window.print(), 50);

  window.onafterprint = ()=>{
    document.body.classList.remove("bulk-printing");
    $("printArea").innerHTML = "";
    window.onafterprint = null;
  };
}

/* ====== Bulk selection helpers ====== */
function toggleBulk(id, checked){
  if(checked) bulkSelection.add(id); else bulkSelection.delete(id);
}
function clearBulk(){
  bulkSelection.clear();
  renderCurrent();
}
function selectFilteredInvoices(limit=30){
  const q = $("q").value.trim();
  const filtered = invoices.filter(i=>matchesQuery(i,q)).slice(0, limit);
  filtered.forEach(i=> bulkSelection.add(i.id));
  renderCurrent();
}

async function bulkPrint(mode){
  const ids = [...bulkSelection];
  if(!ids.length) return toast("Ø­Ø¯Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ (âœ“)");
  if(ids.length > 60){
    if(!confirm("Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ±. Ø§Ù„Ø£ÙØ¶Ù„ 30-50. ØªØªØ§Ø¨Ø¹ØŸ")) return;
  }

  printMode = mode;
  applyPrintCSS(mode);

  const slips = [];
  const posBlocks = [];

  for(const id of ids){
    const inv = invoices.find(x=>x.id===id);
    if(!inv) continue;

    const { data: items } = await sb.from("invoice_items").select("*").eq("invoice_id", id).order("sort_order",{ascending:true});
    const { data: pays }  = await sb.from("payments").select("*").eq("invoice_id", id).order("created_at",{ascending:true});

    if(mode==="a4"){
      slips.push(buildReceiptSlipHTML(inv, items||[], pays||[]));
    }else{
      // POS: Ù†Ø³Ø®ØªÙŠÙ† ÙÙˆÙ‚/ØªØ­Øª + ÙØ§ØµÙ„
      posBlocks.push(buildReceiptPOSHTML(inv, items||[], pays||[]));
      posBlocks.push(`<div style="height:6mm"></div>`);
    }
  }

  if(mode==="a4"){
    if(!slips.length) return toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.");

    const perPage = 5;
    const pages = [];
    for(let i=0;i<slips.length;i+=perPage){
      const chunk = slips.slice(i, i+perPage);
      while(chunk.length < perPage) chunk.push(`<div class="receipt empty"></div>`);
      const isLast = (i + perPage) >= slips.length;
      pages.push(`<div class="sheet">${chunk.join("")}</div>${isLast ? "" : `<div class="pageBreak"></div>`}`);
    }

    document.body.classList.add("bulk-printing");
    $("printArea").innerHTML = pages.join("\n");
  }else{
    if(!posBlocks.length) return toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.");
    document.body.classList.add("bulk-printing");
    $("printArea").innerHTML = posBlocks.join("\n");
  }

  setTimeout(()=>window.print(), 50);

  window.onafterprint = ()=>{
    document.body.classList.remove("bulk-printing");
    $("printArea").innerHTML = "";
    window.onafterprint = null;
  };
}

async function openInvoice(id){
  currentInvoiceId = id;

  const { data: inv, error: e1 } = await sb.from("invoices").select("*").eq("id", id).single();
  if(e1) { toast("Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø¥ÙŠØµØ§Ù„: " + e1.message); return; }

  const { data: items, error: e2 } = await sb.from("invoice_items").select("*").eq("invoice_id", id).order("sort_order",{ascending:true});
  if(e2) { toast("Ø®Ø·Ø£ Ø¨Ù†ÙˆØ¯: " + e2.message); return; }

  const { data: pays, error: e3 } = await sb.from("payments").select("*").eq("invoice_id", id).order("created_at",{ascending:true});
  if(e3) { toast("Ø®Ø·Ø£ Ø¯ÙØ¹Ø§Øª: " + e3.message); return; }

  lastReceiptData = { inv, items: items||[], pays: pays||[] };

  // Ø´Ø§Ø´Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Ù…ÙØµÙ„Ø©) â€” Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© POS Ø£ÙŠØ¶Ø§Ù‹
  $("invoiceView").innerHTML = buildReceiptPaperHTML(inv, items||[], pays||[], {forPrint:false, mode:printMode});
  $("invPageTitle").textContent = "Ø¥ÙŠØµØ§Ù„ " + ((settings?.invoice_prefix||"REC") + "-" + invPublicNo(inv.invoice_no));

  openInvoicePage();
}

/* =========================
   RECEIPT BUILDERS
   ========================= */

/* A4 5-up slip (two copies side-by-side) */
function buildReceiptSlipHTML(inv, items, pays){
  const c = customers.find(x=>x.id===inv.customer_id);
  const cNo = c ? (customerSeqMap.get(c.id)||"") : "";
  const code = `${(settings?.invoice_prefix||"REC")}-${invPublicNo(inv.invoice_no)}`;
  const cur = inv.currency || settings?.currency || "USD";

  const companyName = esc(settings?.company_name||"WiFi Company");
  const companyAddr = esc(settings?.company_address||"");
  const companyPhone = esc(settings?.company_phone||"");

  const first = (items && items[0]) ? unpackItem(items[0].description) : { plan:"â€”", month:"â€”", note:"" };
  const planName = esc(first.plan||"â€”");
  const monthLabel = esc(first.month||"â€”");
  const note = esc(first.note||"");

  const total = Number(inv.total ?? inv.subtotal ?? 0);
  const paid  = Number(inv.paid ?? 0);
  const balance = Number(inv.balance ?? (total - paid));

  const logo = settings?.company_logo_url
    ? `<img class="rlogo" src="${esc(settings.company_logo_url)}">`
    : `<div class="rlogo alt">ğŸ“¶</div>`;

  const custName = esc(c?.full_name||"â€”");
  const custPhone = esc(c?.phone||"");
  const custArea  = esc(c?.area||"");
  const custAddr  = esc(c?.address||"");

  function copy(label){
    return `
      <div class="copy">
        <div class="rhead">
          <div class="rbrand">
            ${logo}
            <div class="rbrandTxt">
              <div class="rbrandName">${companyName}</div>
              ${companyAddr ? `<div class="rbrandMeta">${companyAddr}</div>` : ``}
              ${companyPhone ? `<div class="rbrandMeta">${companyPhone}</div>` : ``}
            </div>
          </div>
          <div class="copyTag">${label}</div>
        </div>

        <div class="rline"></div>

        <div class="rrow"><span>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</span><b>${esc(code)}</b></div>
        <div class="rrow"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span><b>${esc(inv.issue_date||"")}</b></div>

        <div class="rline"></div>

        <div class="rrow"><span>Ø§Ù„Ù…Ø´ØªØ±Ùƒ</span><b>#${esc(cNo)} â€” ${custName}</b></div>
        <div class="rmuted">${custPhone}${custArea?(" â€¢ "+custArea):""}</div>
        ${custAddr ? `<div class="rmuted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${custAddr}</div>` : ``}

        <div class="rline"></div>

        <div class="rrow"><span>Ø§Ù„Ø¨Ø§Ù‚Ø©</span><b>${planName}</b></div>
        <div class="rrow"><span>Ø¹Ù† Ø´Ù‡Ø±</span><b>${monthLabel}</b></div>
        ${note ? `<div class="rmuted">Ù…Ù„Ø§Ø­Ø¸Ø©: ${note}</div>` : ``}

        <div class="rline"></div>

        <div class="rrow"><span>Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</span><b>${money(total)} ${esc(cur)}</b></div>
        <div class="rrow"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><b>${money(paid)} ${esc(cur)}</b></div>
        <div class="rrow"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span><b>${money(balance)} ${esc(cur)}</b></div>

        <div class="rsig">
          <span>ØªÙˆÙ‚ÙŠØ¹</span>
          <span>Ø®ØªÙ…</span>
        </div>
      </div>
    `;
  }

  return `
    <div class="receipt receiptSlip">
      <div class="receiptRow">
        ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø±ÙƒØ©")}
        ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ")}
      </div>
    </div>
  `;
}

/* POS 80mm: two copies stacked (company + customer) */
function buildReceiptPOSHTML(inv, items, pays){
  const c = customers.find(x=>x.id===inv.customer_id);
  const cNo = c ? (customerSeqMap.get(c.id)||"") : "";
  const cur = inv.currency || settings?.currency || "USD";
  const code = `${(settings?.invoice_prefix||"REC")}-${invPublicNo(inv.invoice_no)}`;

  const first = (items && items[0]) ? unpackItem(items[0].description) : { plan:"â€”", month:"â€”", note:"" };
  const planName = esc(first.plan||"â€”");
  const monthLabel = esc(first.month||"â€”");

  const total = Number(inv.total ?? inv.subtotal ?? 0);
  const paid  = Number(inv.paid ?? 0);
  const balance = Number(inv.balance ?? (total - paid));

  const companyName = esc(settings?.company_name||"WiFi Company");
  const companyAddr = esc(settings?.company_address||"");
  const companyPhone = esc(settings?.company_phone||"");
  const logo = settings?.company_logo_url
    ? `<img class="rlogo" src="${esc(settings.company_logo_url)}">`
    : `<div class="rlogo alt">ğŸ“¶</div>`;

  function copy(label){
    return `
      <div style="padding:10px 10px 8px 10px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
          <div style="display:flex;gap:8px;align-items:center">
            ${logo}
            <div>
              <div style="font-weight:900;font-size:13px;line-height:1.1">${companyName}</div>
              ${companyAddr?`<div style="font-size:10px;color:#666">${companyAddr}</div>`:``}
              ${companyPhone?`<div style="font-size:10px;color:#666">${companyPhone}</div>`:``}
            </div>
          </div>
          <div style="font-size:10px;font-weight:800;border:1px solid #ddd;border-radius:10px;padding:3px 8px;background:#f8fafc">${label}</div>
        </div>

        <div style="height:1px;background:#e5e7eb;margin:8px 0"></div>

        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:#666">Ø±Ù‚Ù…</span><b>${esc(code)}</b></div>
        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:#666">ØªØ§Ø±ÙŠØ®</span><b>${esc(inv.issue_date||"")}</b></div>

        <div style="height:1px;background:#e5e7eb;margin:8px 0"></div>

        <div style="font-size:11px"><span style="color:#666">Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</span> <b>#${esc(cNo)} â€” ${esc(c?.full_name||"â€”")}</b></div>
        ${c?.address ? `<div style="font-size:10px;color:#666;margin-top:2px">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${esc(c.address)}</div>` : ``}

        <div style="height:1px;background:#e5e7eb;margin:8px 0"></div>

        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:#666">Ø§Ù„Ø¨Ø§Ù‚Ø©</span><b>${planName}</b></div>
        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:#666">Ø¹Ù† Ø´Ù‡Ø±</span><b>${monthLabel}</b></div>

        <div style="height:1px;background:#e5e7eb;margin:8px 0"></div>

        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:#666">Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</span><b>${money(total)} ${esc(cur)}</b></div>
        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:#666">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><b>${money(paid)} ${esc(cur)}</b></div>
        <div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:#666">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span><b>${money(balance)} ${esc(cur)}</b></div>

        <div style="border-top:1px dashed #cbd5e1;margin-top:10px;padding-top:8px;font-size:10px;color:#666;display:flex;justify-content:space-between">
          <span>ØªÙˆÙ‚ÙŠØ¹</span><span>Ø®ØªÙ…</span>
        </div>
      </div>
    `;
  }

  return `
    <div class="posPaper">
      ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø±ÙƒØ©")}
      <div class="pos-sep"></div>
      ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ")}
    </div>
  `;
}

/* Screen receipt (full, similar to old invoice paper) */
function buildReceiptPaperHTML(inv, items, pays, opts){
  const prefs = getPrefs();
  const c = customers.find(x=>x.id===inv.customer_id);
  const cNo = c ? (customerSeqMap.get(c.id)||"") : "";
  const cur = inv.currency || settings?.currency || "USD";
  const mode = opts?.mode || "a4";
  const forPrint = !!opts?.forPrint;

  const code = `${(settings?.invoice_prefix||"REC")}-${invPublicNo(inv.invoice_no)}`;
  const companyName = esc(settings?.company_name||"WiFi Company");
  const companyAddr = esc(settings?.company_address||"");
  const companyPhone = esc(settings?.company_phone||"");

  const first = (items && items[0]) ? unpackItem(items[0].description) : { plan:"â€”", month:"â€”", note:"" };
  const planName = esc(first.plan||"â€”");
  const monthLabel = esc(first.month||"â€”");
  const note = esc(first.note||"");

  const total = Number(inv.total ?? inv.subtotal ?? 0);
  const paid  = Number(inv.paid ?? 0);
  const balance = Number(inv.balance ?? (total - paid));

  const logo = settings?.company_logo_url
    ? `<img class="rlogo" src="${esc(settings.company_logo_url)}">`
    : `<div class="rlogo alt">ğŸ“¶</div>`;

  const paperW = forPrint
    ? (mode==="pos" ? "80mm" : "190mm")
    : (prefs.invW + "px");
  const paperH = forPrint
    ? "auto"
    : (prefs.invH + "px");

  function copy(label){
    return `
      <div class="copy">
        <div class="rhead">
          <div class="rbrand">
            ${logo}
            <div class="rbrandTxt">
              <div class="rbrandName">${companyName}</div>
              ${companyAddr ? `<div class="rbrandMeta">${companyAddr}</div>` : ``}
              ${companyPhone ? `<div class="rbrandMeta">${companyPhone}</div>` : ``}
            </div>
          </div>
          <div class="copyTag">${label}</div>
        </div>

        <div class="rline"></div>

        <div class="rrow"><span>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</span><b>${esc(code)}</b></div>
        <div class="rrow"><span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span><b>${esc(inv.issue_date||"")}</b></div>

        <div class="rline"></div>

        <div class="rrow"><span>Ø§Ù„Ù…Ø´ØªØ±Ùƒ</span><b>#${esc(cNo)} â€” ${esc(c?.full_name||"â€”")}</b></div>
        <div class="rmuted">${esc(c?.phone||"")}${c?.area?(" â€¢ "+esc(c.area)):""}</div>
        ${c?.address ? `<div class="rmuted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${esc(c.address)}</div>` : ``}

        <div class="rline"></div>

        <div class="rrow"><span>Ø§Ù„Ø¨Ø§Ù‚Ø©</span><b>${planName}</b></div>
        <div class="rrow"><span>Ø¹Ù† Ø´Ù‡Ø±</span><b>${monthLabel}</b></div>
        ${note ? `<div class="rmuted">Ù…Ù„Ø§Ø­Ø¸Ø©: ${note}</div>` : ``}

        <div class="rline"></div>

        <div class="rrow"><span>Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</span><b>${money(total)} ${esc(cur)}</b></div>
        <div class="rrow"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><b>${money(paid)} ${esc(cur)}</b></div>
        <div class="rrow"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span><b>${money(balance)} ${esc(cur)}</b></div>

        <div class="rsig">
          <span>ØªÙˆÙ‚ÙŠØ¹</span>
          <span>Ø®ØªÙ…</span>
        </div>
      </div>
    `;
  }

  const inner = (mode==="pos")
    ? `<div class="receiptCol">
        ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø±ÙƒØ©")}
        <div class="pos-sep"></div>
        ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ")}
      </div>`
    : `<div class="receiptRow">
        ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø±ÙƒØ©")}
        ${copy("Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ")}
      </div>`;

  return `
    <div class="invpaper receiptScreen" style="width:${paperW}; height:${paperH};">
      ${inner}
    </div>
  `;
}


/* =========================
   CUSTOMER MODAL
   ========================= */
function openCustomerModal(customerId){
  currentCustomerId = customerId;
  const c = customers.find(x=>x.id===customerId);
  if(!c) return;

  const no = customerSeqMap.get(c.id) || "";
  $("custModalTitle").textContent = `Ù…Ù„Ù Ø§Ù„Ø²Ø¨ÙˆÙ† â€” #${no}`;

  const custSubs = subs.filter(s=>s.customer_id===customerId);
  const custInv = invoices.filter(i=>i.customer_id===customerId);

  const subRows = custSubs.map(s=>`
    <tr>
      <td><b>${esc(s.plan_name||"â€”")}</b></td>
      <td>${esc(s.start_date||"")} â†’ ${esc(s.end_date||"")}</td>
      <td>${badgeDays(s.days_left)}</td>
    </tr>
  `).join("");

  const invRows = custInv.map(i=>{
    const code = `${settings?.invoice_prefix||"REC"}-${invPublicNo(i.invoice_no)}`;
    const total = Number(i.total ?? i.subtotal ?? 0);
    const balance = Number(i.balance ?? (total - Number(i.paid||0)));
    return `
      <tr>
        <td><b>${esc(code)}</b></td>
        <td>${esc(i.issue_date||"")}</td>
        <td>${money(total)} ${esc(i.currency||settings?.currency||"USD")}</td>
        <td>${money(balance)}</td>
        <td class="no-print"><button class="btn" type="button" onclick="openInvoice('${i.id}')">ÙØªØ­</button></td>
      </tr>
    `;
  }).join("");

  $("custModalBody").innerHTML = `
    <div class="badge b-ok">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†</div>
    <div class="hr"></div>

    <div class="card" style="padding:12px 14px;border-radius:18px;box-shadow:none">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-size:18px"><b>#${no} â€” ${esc(c.full_name)}</b></div>
          <div class="tiny muted">${esc(c.phone||"")} â€¢ ${esc(c.area||"")}</div>
          <div class="tiny muted">${esc(c.address||"")}</div>
          <div class="tiny muted">${c.username ? ("ÙŠÙˆØ²Ø±: "+esc(c.username)) : ""}</div>
        </div>
        <div style="min-width:220px">
          <div class="badge">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª: <b>${custInv.length}</b></div>
          <div style="height:8px"></div>
          <button class="btn ok" type="button" onclick="setTab('invoices'); closeCustomerModal();">Ø¥Ù†Ø´Ø§Ø¡ Ø¥ÙŠØµØ§Ù„</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <b>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</b>
    <table>
      <thead><tr><th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th></tr></thead>
      <tbody>${subRows || `<tr><td colspan="3" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª.</td></tr>`}</tbody>
    </table>

    <div class="hr"></div>

    <b>Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</b>
    <table>
      <thead><tr><th>Ø±Ù‚Ù…</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th class="no-print">ÙØªØ­</th></tr></thead>
      <tbody>${invRows || `<tr><td colspan="5" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª.</td></tr>`}</tbody>
    </table>
  `;

  $("custModal").classList.add("show");
}
function closeCustomerModal(){
  $("custModal").classList.remove("show");
  currentCustomerId = null;
}

/* =========================
   SETTINGS
   ========================= */
async function saveSettings(){
  const payload = {
    company_name: $("set_name")?.value?.trim() || "",
    company_phone: $("set_phone")?.value?.trim() || "",
    company_address: $("set_addr")?.value?.trim() || "",
    company_logo_url: $("set_logo")?.value?.trim() || "",
    invoice_prefix: ($("set_pref")?.value?.trim() || "REC"),
    currency: ($("set_cur")?.value?.trim() || "USD")
  };
  if(!payload.company_name) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©");

  const { data: rows, error: e1 } = await sb.from("settings").select("*").order("created_at",{ascending:true}).limit(1);
  if(e1) return toast("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: " + e1.message);

  if(rows?.length){
    const { error } = await sb.from("settings").update(payload).eq("id", rows[0].id);
    if(error) return toast("Ø®Ø·Ø£ Ø­ÙØ¸: " + error.message);
  }else{
    const { error } = await sb.from("settings").insert(payload);
    if(error) return toast("Ø®Ø·Ø£ Ø­ÙØ¸: " + error.message);
  }

  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âœ…");
  closeFormModal();
  await reloadAll(true);
}

function saveScreenPrefs(){
  const w = Number($("pref_w")?.value||0);
  const h = Number($("pref_h")?.value||0);
  if(!w || !h) return toast("Ø§ÙƒØªØ¨ Ù…Ù‚Ø§Ø³ ØµØ­ÙŠØ­");
  savePrefs(w, h);
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ø³ âœ…");
  closeFormModal();
  renderCurrent();
}

function previewInvoiceSample(){
  const fakeInv = {
    id:"preview",
    customer_id: customers?.[0]?.id || null,
    invoice_no: 1,
    issue_date: new Date().toISOString().slice(0,10),
    currency:(settings?.currency||"USD"),
    status:"unpaid",
    subtotal:20, discount:0, total:20, paid:0, balance:20
  };
  const fakeItems = [{ description: packItem("GB 10", "Ø§Ù„Ø´Ù‡Ø± 1 (Ø§Ù„Ø£ÙˆÙ„)", "Ù…Ø¹Ø§ÙŠÙ†Ø©"), qty:1, unit_price:20, sort_order:1 }];
  const fakePays = [];
  $("invoiceView").innerHTML = buildReceiptPaperHTML(fakeInv, fakeItems, fakePays, {forPrint:false, mode:printMode});
  $("invPageTitle").textContent = "Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¥ÙŠØµØ§Ù„";
  openInvoicePage();
}

async function handleLogoUpload(input){
  const file = input.files?.[0];
  if(!file) return;
  if(file.size > 800*1024){
    return toast("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±. Ø¬Ø±Ù‘Ø¨ ØµÙˆØ±Ø© Ø£ØµØºØ± (Ø£Ù‚Ù„ Ù…Ù† 800KB).");
  }
  const reader = new FileReader();
  reader.onload = ()=>{
    $("set_logo").value = String(reader.result||"");
    toast("ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù„ÙˆØºÙˆ âœ… Ø§Ø¶ØºØ· Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
  };
  reader.readAsDataURL(file);
}

/* =========================
   COUNTDOWN LOOP
   ========================= */
function startCountdownLoop(){
  if(countdownTimer) return;
  countdownTimer = setInterval(updateCountdowns, 1000);
  updateCountdowns();
}
function updateCountdowns(){
  if(TAB !== "countdown") return;
  document.querySelectorAll(".ccard[data-end]").forEach(card=>{
    const end = Number(card.getAttribute("data-end")||0);
    const subId = card.getAttribute("data-sub");
    const wrap = document.getElementById("cd_"+subId);
    if(!wrap) return;

    let diff = end - Date.now();
    if(!Number.isFinite(diff)) diff = 0;
    if(diff < 0) diff = 0;

    const sec = Math.floor(diff/1000);
    const days = Math.floor(sec/86400);
    const hours = Math.floor((sec%86400)/3600);
    const mins = Math.floor((sec%3600)/60);
    const secs = Math.floor(sec%60);

    const cells = wrap.querySelectorAll(".cd .n");
    if(cells.length>=4){
      cells[0].textContent = String(days);
      cells[1].textContent = String(hours).padStart(2,"0");
      cells[2].textContent = String(mins).padStart(2,"0");
      cells[3].textContent = String(secs).padStart(2,"0");
    }
  });
}

/* =========================
   Resume fix
   ========================= */
document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden){
    const tooOld = (Date.now() - lastLoadedAt) > 15000;
    if(tooOld) reloadAll(false);
    else renderCurrent();
    setTimeout(()=>{ updateHeaderH(); fitInvoiceToViewport(); }, 200);
  }
});
window.addEventListener("pageshow", ()=>{
  const tooOld = (Date.now() - lastLoadedAt) > 15000;
  if(tooOld) reloadAll(false);
});

/* =========================
   Robust errors for â€œsite hangsâ€
   ========================= */
window.addEventListener("unhandledrejection", (e)=>{
  console.error("Unhandled promise rejection:", e.reason);
  $("authState").textContent = "Ù…Ø´ÙƒÙ„Ø© âš ï¸";
});
window.addEventListener("error", (e)=>console.error(e.error||e.message||e));

/* =========================
   INIT
   ========================= */
(function init(){
  updateHeaderH();

  // âœ… Check Supabase library loaded (common â€œhangâ€ cause on websites)
  if(!window.supabase || !window.supabase.createClient){
    $("authState").textContent = "Supabase CDN âš ï¸";
    toast("Ù…ÙƒØªØ¨Ø© Supabase Ù…Ø§ ØªØ­Ù…Ù‘Ù„Øª. Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª/Ø§Ù„Ø­Ø¸Ø±.");
    return;
  }

  sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // âœ… Ø¥Ø°Ø§ ÙØªØ­ØªÙ‡ ÙƒÙ€ file:// Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„ØªØ®Ø²ÙŠÙ†
  try{
    if(location.protocol === "file:"){
      toast("Ù…Ù„Ø§Ø­Ø¸Ø©: ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙƒÙ€ file:// Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©. Ø§Ù„Ø£ÙØ¶Ù„ ÙØªØ­Ù‡ ÙƒØ±Ø§Ø¨Ø· (Netlify) Ø£Ùˆ Ø¯Ø§Ø®Ù„ Chrome.");
    }
  }catch(e){}

  reloadAll(true);
})();
</script>

<style>
  #snackbar{
    position:fixed;
    left:12px; right:12px;
    bottom:calc(12px + env(safe-area-inset-bottom,0px));
    background:rgba(15,23,42,.92);
    color:#fff;
    padding:12px 14px;
    border-radius:14px;
    box-shadow:0 18px 40px rgba(2,6,23,.25);
    z-index:9998;
    display:none;
    font-size:13px;
    line-height:1.4;
  }
  #snackbar.show{ display:block; }
</style>
<div id="snackbar" class="no-print"></div>

</body>
</html>
